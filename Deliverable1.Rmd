---
title: "Load Data and Set Sample"
author: "Josep Franquet Fabregas"
date: \today
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
  html_document:
    toc: no
    toc_depth: '4'
  word_document:
    toc: no
    toc_depth: '4'
geometry: left=1.9cm,right=1.9cm,top=1.25cm,bottom=1.52cm
fontsize: 18pt
subtitle: 'Laboratori 1 - Data Preparation'
classoption: a4paper
editor_options: 
  chunk_output_type: console
---

# Presentation - Títol nivell 1
## R Markdowns document - Títol nivell 2

This is an R Markdown document. 
We are showing some examples of GLMz. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>. Use * to provide emphasis such as *italics* and **bold**.

Create lists: Unordered * and +     or   ordered   1. 2.  

  1. Item 1
  2. Item 2
    + Item 2a
    + Item 2b

# Header 1
## Header 2

## Data Description: 100,000 UK Used Car Data set
 
This data dictionary describes data  (https://www.kaggle.com/adityadesai13/used-car-dataset-ford-and-mercedes) - A sample of 5000 trips has been randomly selected from Mercedes, BMW, Volkwagen and Audi manufacturers. So, firstly you have to combine used car from the 4 manufacturers into 1 dataframe.

The cars with engine size 0 are in fact electric cars, nevertheless Mercedes C class, and other given cars are not electric cars,so data imputation is requered. 


  -   manufacturer	Factor: Audi, BMW, Mercedes or Volkswagen
  -   model	Car model
  -   year	registration year
  -   price	price in £
  -   transmission	type of gearbox
  -   mileage	distance used
  -   fuelType	engine fuel
  -   tax	road tax
  -   mpg	Consumption in miles per gallon   
  -   engineSize	size in litres


# Load Required Packages: to be increased over the course

```{r}
# Load Required Packages: to be increased over the course
options(contrasts=c("contr.treatment","contr.treatment"))

requiredPackages <- c("effects","FactoMineR","car", "factoextra","RColorBrewer","ggplot2","dplyr","ggmap","ggthemes","knitr")

#use this function to check if each package is on the local machine
#if a package is installed, it will be loaded
#if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(requiredPackages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})
#verify they are loaded
search()

```

## Select a sample of 5000 records

```{r}
# Clear plots
if(!is.null(dev.list())) dev.off()

# Clean workspace
rm(list=ls())

setwd("C:/Users/Miquel/Documents/GitHub/ADEI")
filepath<-"C:/Users/Miquel/Documents/GitHub/ADEI/"

load(paste0(filepath,"MyOldCars-Raw.RData"))
```

## Some useful functions

```{r, echo=FALSE}

# Mout <- which((df$tax < var_out$mouti)|(df$tax > var_out$mouts))

# Some useful functions
calcQ <- function(x) {
  s.x <- summary(x)
  iqr<-s.x[5]-s.x[2]
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2], q2=s.x[3], 
       q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr ) }

countNA <- function(x) {
  mis_x <- NULL
  for (j in 1:ncol(x)) {mis_x[j] <- sum(is.na(x[,j])) }
  mis_x <- as.data.frame(mis_x)
  rownames(mis_x) <- names(x)
  mis_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {mis_i <- mis_i + as.numeric(is.na(x[,j])) }
  list(mis_col=mis_x,mis_ind=mis_i) }

countX <- function(x,X) {
  n_x <- NULL
  for (j in 1:ncol(x)) {n_x[j] <- sum(x[,j]==X) }
  n_x <- as.data.frame(n_x)
  rownames(n_x) <- names(x)
  nx_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {nx_i <- nx_i + as.numeric(x[,j]==X) }
  list(nx_col=n_x,nx_ind=nx_i) }

```

## Factors: Levels coding

Now codify properly factors and remove non-informative variables
```{r}
summary(df)
names(df)


#MODEL
df$model<-factor(paste0(df$manufacturer,"-",df$model)) #paste sep="" quitar espacio puede
df$model<-factor(df$model,labels=paste0("f.Model",levels(df$model))) # o F.Mod # puede sobre (SOBRAR) levels
levels(df$model)
barplot(summary(df$model), main = "Model Barplot", col = "blue")
table(df$model)
summary(df$model)

#TRANSMISSION
df$transmission <- factor(df$transmission)
levels(df$transmission)
df$transmission <- factor(df$transmission, levels = c("Manual","Semi-Auto","Automatic"),labels = paste0("f.Trans-",c("Manual","SemiAuto","Automatic")))#mapeo en orden y cambiar algun level (sin guion en este caso)
#df$transmission <- factor(df$transmission, levels = levels(df$transmission),labels = paste0("f.Trans-",levels(df$transmission))) 
head(df)
barplot(summary(df$transmission), main = "Transmission Barplot", col = "blue")

#FUELTYPE
df$fuelType <- factor(df$fuelType)
levels(df$fuelType)
df$fuelType <- factor(df$fuelType, levels = c("Diesel","Petrol","Hybrid","Other"), labels = paste0("f.Fuel-",c("Diesel","Petrol","Hybrid","Other")))
df$fuelType <- factor(df$fuelType, labels = paste0("f.Fuel-",levels(df$fuelType)))
barplot(summary(df$fuelType), main = "FuelType Barplot", col = "blue")

#ENGINESIZE
df$engineSize <- factor(df$engineSize)
df$engineSize <- factor(df$engineSize, labels = paste0("f.EngSize-",levels(df$engineSize))) 
barplot(summary(df$engineSize), main = "EngineSize Barplot", col = "blue")

#MANUFACTURER
df$manufacturer <- factor(df$manufacturer)
df$manufacturer <- factor(df$manufacturer, labels = paste0("f.Mfr-",levels(df$manufacturer)))
barplot(summary(df$manufacturer), main = "Manufacturer Barplot", col = "blue")

#YEAR
df$year <- factor(df$year)
df$year <- factor(df$year, labels = paste0("f.Year-",levels(df$year)))
barplot(summary(df$year), main = "Year Barplot", col = "blue")
# Remove uninformative variables from data.frame if present
```

```{r}
summary(df$mpg)
table(df$fuelType)


table(df$year)

df[which(df$year<=2009),"year"] <- "2009 or before"
df$year<-factor(df$year)
levels(df$year)
barplot(table(df$year))

table(df$engineSize)
df[which(df$engineSize>=4.0),"engineSize"] <- "4.0 or more" #or with 3.2 or 4.2

table(df$years_sell)
df[which(df$years_sell>=13),"years_sell"] <- "13 or more"
```

```{r}
rm(list=ls())
```


## Discretization 

```{r}
####    Discretization of all variables, for example price
# In this case, discretization: 4 levels are considered, from the quartiles
## Check for missings, outliers and errors

summary(df$price)
boxplot(df$price)

setwd("C:/Users/Miquel/Documents/GitHub/ADEI")
filepath<-"C:/Users/Miquel/Documents/GitHub/ADEI/"

load(paste0(filepath,"MyOldCars-Raw.RData"))

quantile(df$price,seq(0,1,0.25),na.rm=TRUE)
quantile(df$price,seq(0,1,0.1),na.rm=TRUE)

df$f.price<-factor(cut(df$price/1000,breaks=c(quantile(df$price,seq(0,1,0.25),na.rm=TRUE)/1000),include.lowest = T ))
summary(df$f.price)
tapply(df$price,df$f.price,median)
levels(df$f.price)<-paste("f.price-",levels(df$f.price))
table(df$f.price,useNA="always")

df$f.price<-factor(cut(df$price/1000,breaks=c(0,15,20,26, 90),include.lowest = F ))
levels(df$f.price)<-paste("f.price-",levels(df$f.price))
?paste
table(df$f.price,useNA="always")

####    Discretization of all numeric variables 
vars_con
summary(df$mileage)
Boxplot(df$mileage)

quantile(df$mileage,seq(0,1,0.25),na.rm=TRUE)
quantile(df$mileage,seq(0,1,0.1),na.rm=TRUE)

df$f.mileage<-factor(cut(df$mileage,breaks=c(quantile(df$mileage,seq(0,1,0.25),na.rm=TRUE)),include.lowest = T ))
summary(df$f.mileage)
tapply(df$mileage,df$f.mileage,median)
levels(df$f.mileage)<-paste("f.mileage-",levels(df$f.mileage))
table(df$f.mileage,useNA="always")

df$f.miles<-factor(cut(df$mileage/1000,breaks=c(0,6,18,36, 195),include.lowest = T ))
levels(df$f.miles)<-paste("f.miles-",levels(df$f.miles),sep="")
table(df$f.miles,useNA="always")

vars_con
summary(df$tax)
Boxplot(df$tax)

quantile(df$tax,seq(0,1,0.25),na.rm=TRUE)
quantile(df$tax,seq(0,1,0.1),na.rm=TRUE)

# df$aux<-factor(cut(df$tax,breaks=quantile(df$tax,seq(0,1,0.25),na.rm=TRUE),include.lowest = T )) # Does not work
df$f.tax<-factor(cut(df$tax,breaks=c(quantile(df$tax,seq(0,1,0.25),na.rm=TRUE)),include.lowest = T ))
summary(df$f.tax)
tapply(df$tax,df$f.tax,median)
levels(df$f.tax)<-paste("f.tax-",levels(df$f.tax))
table(df$f.tax,useNA="always")


df$f.tax<-factor(cut(df$tax,breaks=c(0, 125, 145, 570),include.lowest = T ))
levels(df$f.tax)<-paste("f.tax-",levels(df$f.tax),sep="")
table(df$f.tax,useNA="always")



vars_con
summary(df$mpg)
Boxplot(df$mpg)

quantile(df$mpg,seq(0,1,0.25),na.rm=TRUE)
quantile(df$mpg,seq(0,1,0.1),na.rm=TRUE)

df$f.mpg<-factor(cut(df$mpg,breaks=c(quantile(df$mpg,seq(0,1,0.25),na.rm=TRUE)),include.lowest = T ))
summary(df$f.mpg)
tapply(df$mpg,df$f.mpg,median)
levels(df$f.mpg)<-paste("f.mpg-",levels(df$f.mpg))
table(df$f.mpg,useNA="always")


vars_con
summary(df$years_sell)
Boxplot(df$years_sell)

quantile(df$years_sell,seq(0,1,0.25),na.rm=TRUE)
quantile(df$years_sell,seq(0,1,0.1),na.rm=TRUE)

df$f.years_sell<-factor(cut(df$years_sell,breaks=c(quantile(df$years_sell,seq(0,1,0.25),na.rm=TRUE)),include.lowest = T ))
summary(df$f.years_sell)
tapply(df$years_sell,df$f.years_sell,median)
levels(df$f.years_sell)<-paste("f.years_sell-",levels(df$f.years_sell))
table(df$f.years_sell,useNA="always")


# Repeat the procedure for all numeric variables
# 
```

## Definition of binary outcome: Audi

Create binary target, define lists of numeric and qualitative variables and save your raw base database

```{r}

# Binary Target: Audi?

df$Audi<-ifelse(df$manufacturer == "Audi",1,0)
df$Audi<-factor(df$Audi,labels=paste("Audi",c("No","Yes")))
summary(df$Audi)
# Pie
piepercent<-round(100*(table(df$Audi)/nrow(df)),dig=2); piepercent
pie(table(df$Audi),col=heat.colors(2),labels=paste(piepercent,"%"))
legend("topright", levels(df$Audi), cex = 0.8, fill = heat.colors(2))
# Bar Chart
barplot(table(df$Audi),main="Barplot Binary Outcome - Factor",col=c("red","green"))#col=rainbow(2)

```

# Examples for Imputation. Multivariant Outlier detection first

```{r}
library(mvoutlier)
names(df)
vout<-aq.plot(df[,c(3,5,8, 11)], delta=qchisq(0.95,3),alpha=0.05)
summary(df)


library(chemometrics)
dis <- Moutlier(df[,c(3,5,8, 11)], quantile = 0.995)
dis$cutoff
sqrt(qchisq(0.995,3))
str(dis)
par(mfrow=c(1,1))
plot(dis$md,dis$rd, type="n")
text(dis$md,dis$rd,labels=rownames(df[,c(3,5,8, 11)]))
abline(h=dis$cutoff,col="red",lwd=2)
abline(v=dis$cutoff,col="red",lwd=2)

abline(h=dis$cutof^2,col="red",lwd=2,lty=2)
abline(v=dis$cutoff^2,col="red",lwd=2,lty=2)
```


## Imputation of numeric variables

```{r}
library(missMDA)
# Now one by one describe vars and put them on lists
names(df)
df$engineSize <- factor(df$engineSize)
names(df)
vars_con<-names(df)[c(3,5,7,8, 11)]#NUMERQIUES #SOBRA 3????
vars_dis<-names(df)[c(1:2, 4, 6, 9, 10)]#CATEGORIQUES
vars_res<-names(df)[c(3)]#TARGET REPOSTA

summary(df[,vars_con])
res.impca<-imputePCA(df[,vars_con],ncp=4)#NOMBRE COMPONENTS PRICNIPALS
#COMPLETEOBS - OBJECTE ON NO HI HA MISSINGS

summary(res.impca$completeObs)

# Check one by one
res.impca$completeObs[ selmiss,"engineSize"]
res.impca$completeObs[ selmiss,"engineSize"]<-3
par(nfrow=c(1,2))
hist(df$tax)
hist(res.impca$completeObs[,"tax"])
quantile(df$tax,seq(0,1,0.1),na.rm=T)
round(quantile(res.input$completeObs[,"tax"],seq(0,1,0.1),na.rm=T),dig=1)


names(df)
par(nfrow = c(1,2))
hist(df$mileage)
hist(res.impca$completeObs[,"mileage"])
quantile(df$mileage,seq(0,1,0.1),na.rm=T)
round(quantile(res.input$completeObs[,"mileage"],seq(0,1,0.1),na.rm=T),dig=1)

par(nfrow = c(1,2))
hist(df$mpg)
hist(res.impca$completeObs[,"mpg"])
quantile(df$mpg,seq(0,1,0.1),na.rm=T)
round(quantile(res.input$completeObs[,"mpg"],seq(0,1,0.1),na.rm=T),dig=1)

par(nfrow = c(1,2))
hist(df$years_sell)
hist(res.impca$completeObs[,"years_sell"])
quantile(df$years_sell,seq(0,1,0.1),na.rm=T)
round(quantile(res.input$completeObs[,"years_sell"],seq(0,1,0.1),na.rm=T),dig=1)


df[ , vars_con ]<-res.impca$completeObs   # Once you have validated the process
#INTEGER0 == null???
```

## Imputation of qualitative variables

```{r}
summary(df[,vars_dis])
res.immca<-imputeMCA(df[,vars_dis],ncp=10)
??imputePCA
summary(res.immca$completeObs)
df [c(1:2, 4, 6, 9, 10)] <- res.immca$completeObs
# Check one by one
par(mfrow=c(1,2))
barplot(table(df$model),col="red")
barplot(table(res.input$completeObs[,"model"]),col="blue")

par(mfrow=c(1,2))
barplot(table(df$year),col="red")
barplot(table(res.input$completeObs[,"year"]),col="blue")

par(mfrow=c(1,2))
barplot(table(df$transmission),col="red")
barplot(table(res.input$completeObs[,"transmission"]),col="blue")

par(mfrow=c(1,2))
barplot(table(df$fuelType),col="red")
barplot(table(res.input$completeObs[,"fuelType"]),col="blue")

par(mfrow=c(1,2))
barplot(table(df$engineSize),col="red")
barplot(table(res.input$completeObs[,"engineSize"]),col="blue")

par(mfrow=c(1,2))
barplot(table(df$manufacturer),col="red")
barplot(table(res.input$completeObs[,"manufacturer"]),col="blue")


# df[ , vars_dis ]<-res.immca$completeObs   # Once you have validated the process

```



# Initialization of counts for missings, outliers and errors. All numerical variables have to be checked before

```{r}

#######################################################
imis<-rep(0,nrow(df))  # rows - cars
jmis<-rep(0,2*ncol(df))  # columns - variables
######################################################
mis1<-countNA(df) #There are no missings at the beginning 
mis1$mis_ind # Number of missings for the current set of cars
mis1$mis_col # Number of missings for the current set of variables

sum(mis1$mis_ind)
sum(mis1$mis_col)

#######################################################
iouts<-rep(0,nrow(df))  # rows - cars
jouts<-rep(0,2*ncol(df))  # columns - variables
######################################################

#######################################################
ierrs<-rep(0,nrow(df))  # rows - cars
jerrs<-rep(0,2*ncol(df))  # columns - variables
######################################################
#sobra 2 diu profe
```


## Data Coding and Clearance

Create new variables derived from the original ones, as years_sell

```{r}
summary(df$model)
# It is a categorical(=factor) variable   NO PROBLEM

####   Variable df$Store_and_fwd_flag
summary(df$year)
df$years_sell <-  2022 - df$year 
df$year<-factor(df$year)
# It is a categorical(=factor) variable   NO PROBLEM 
```

```{r}
df[which(df[,"engineSize"]==0),]#electrico poner mas cosas??
sel<-which(df$engineSize==0 & df$fuelType!="f.Fuel-Electric")

# It is a quantitive variable  Non-possible values will be recoded to NA
sel<-which(df$engineSize==0)
ierrs[sel]<-ierrs[sel]+1
sel                 #### sel contains the rownames of the individuals with "0" 
#                        as  value for engineSize
# df[sel,"engineSize"]<-3    # non-possible values are replaced by NA, missing value symbol in R
df[sel,"engineSize"]<-NA
selmiss <- sel
selmiss
jerrs[3] <- length(sel) #NEW TODAY
jerrs[3] <- length(selmiss)

names(df)

Boxplot(df$price)
var_out<-calcQ(df$price)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_price<-which((df$price<var_out$souti)|(df$price>var_out$souts))#souts abline
iouts[llout_price]<-iouts[llout_price]+1
# Assignation of an NA to my response variable:
#df[llout_price,"price"]<-NA #llout

Boxplot(df$mpg)
var_out<-calcQ(df$mpg)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_mpg<-which((df$mpg<var_out$souti)|(df$mpg>var_out$souts))#souts abline
iouts[llout_mpg]<-iouts[llout_mpg]+1
jouts[]<-length(llout_mpg)
# Assignation of an NA to my response variable:
df[llout_mpg,"mpg"]<-NA #llout


Boxplot(df$mileage)
var_out<-calcQ(df$mileage)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_mileage<-which((df$mileage<var_out$souti)|(df$mileage>var_out$souts))#souts abline
iouts[llout_mileage]<-iouts[llout_mileage]+1
# Assignation of an NA to my response variable:
df[llout_mileage,"mileage"]<-NA #llout


Boxplot(df$tax)
var_out<-calcQ(df$tax)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_tax<-which((df$tax<var_out$souti)|(df$tax>var_out$souts))#souts abline
iouts[llout_tax]<-iouts[llout_tax]+1
# Assignation of an NA to my response variable:
df[llout_tax,"tax"]<-NA #llout


Boxplot(df$years_sell)
var_out<-calcQ(df$years_sell)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_years_sell<-which((df$years_sell<var_out$souti)|(df$years_sell>var_out$souts))#souts abline
iouts[llout_years_sell]<-iouts[llout_years_sell]+1
# Assignation of an NA to my response variable:
df[llout_years_sell,"years_sell"]<-NA #llout

```


## Data Quality report (missings/errors/outliers) and remove observations with missings in targets #DELIVERABLE ANTIGUOO

```{r}
mis1<-countNA(df)
mis1$mis_col
mis1$mis_ind
summary( mis1$mis_ind )

# Number of missing values of each variable
missings_ranking_sortlist <- sort.list(mis1$mis_col, decreasing = TRUE)
for(j in missings_ranking_sortlist) {
  print(paste(names(df)[j]," : ", mis1$mis_col$mis_x[j]))
}

#Number of errors per each variable
errors_ranking_sortlist <- sort.list(jerrs, decreasing = TRUE)
for(j in errors_ranking_sortlist) {
  if(!is.na(names(df)[j])) { print(paste(names(df)[j], " : ", jerrs[j])) }
}

#Number of outilers per each variable
outliers_ranking_sortlist <- sort.list(jouts, decreasing = TRUE)
for(j in outliers_ranking_sortlist) {
  if(!is.na(names(df)[j])) print(paste(names(df)[j], " : ", jouts[j]))
}

#Number of missing values individual
barplot(table(imis),main = "Missings per individual Barplot", col = "blue")

#Number of errors individual
barplot(table(ierrs), main = "Errors per individual Barplot", col = "blue")

#Number of outliers individual
barplot(table(iouts), main = "Outliers per individual Barplot", col = "blue")

#Create variable adding the total number missing values, outliers and errors
total_missings <- 0
total_errors <- 0
total_outliers <- 0

for(m in imis) { total_missings <- total_missings + m}
for(e in ierrs) {total_errors <- total_errors + e  }
for(o in iouts) {total_outliers <- total_outliers + o }

```

## Profiling

```{r}
##############################################################################
#                                    Profiling 
#                           Package FactoMineR will be used
##############################################################################
library(FactoMineR)
summary(df$price)
# The "variable to describe cannot have NA ###################################
res.condes<-condes(df,3)

res.condes$quanti  # Global association to numeric variables
res.condes$quali # Global association to factors
res.condes$category  # Partial association to significative levels in factors
```

```{r}
##############################################################################
#                                    Profiling 
#                           Package FactoMineR will be used
##############################################################################
library(FactoMineR)
summary(df$y.bin)
# The "variable to describe cannot have NA ###################################
res.catdes<-catdes(df,13)

res.catdes$quanti.var  # Global association to numeric variables
res.catdes$quanti # Partial association of numeric variables to levels of outcome factor
res.catdes$test.chi2 # Global association to factors
res.catdes$category  # Partial association to significative levels in factors
```


##Profiling

```{r}
# Target participation - Factor

# Global association entre participation i la resta  de factors

# Global association entre participation i la resta  de numèriques
oneway.test(df$income~df$participation)  # H0: mean income f.Par-Yes = mean income f.Par-NO pvalue=P(H0)= 2 e-7 << 0.05 -> H0 poc creïble -> H0 Rebutja - Income i Participation estan associades

prop.table(table(df$participation))
prop.table(table(df$foreign))

res.cat<-catdes(df,1)
str(res.cat)
res.cat$quanti.var  # Global association target is factor and explanatory variables numeric
res.cat$quanti # Especific association: target factor and numeric variables
res.cat$test.chi2 # Global association target is factor and explanatory factors
res.cat$category

chisq.test(table(df$foreign,df$participation))

names(df)
res.con<-condes(df,2) # Target income 
res.con$quanti  # Global Association Target income and explanatory covariates
res.con$quali # Global Association Target income and explanatory factors
res.con$category

```
