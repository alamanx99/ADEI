---
title: "USED CAR PRICES CASE STUDY"
subtitle: 'Deliverable I: Data Processing, Description, Validation and Profiling'
author: "Miquel Parra i Xavier Alaman"
date: \today
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
geometry: left=1.9cm,right=1.9cm,top=1.25cm,bottom=1.52cm
fontsize: 18pt
classoption: a4paper
editor_options: 
  chunk_output_type: console
---

# R libraries imports, useful functions and data loading

In this first section we will load all required packages and libraries, declare additional functions, and load our data.

## Load required packages

```{r, message=FALSE, warning=FALSE, results='hide'}
options(contrasts=c("contr.treatment","contr.treatment"))

requiredPackages <- c("effects","FactoMineR","car", 
                      "factoextra","RColorBrewer","ggplot2","dplyr","ggmap",
                      "ggthemes","knitr","treemap")

#use this function to check if each package is on the local machine
#if a package is installed, it will be loaded
#if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(requiredPackages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})

#verify they are loaded
search()
```

## Useful functions

```{r}
# Mout <- which((df$tax < var_out$mouti)|(df$tax > var_out$mouts))

# Some useful functions
calcQ <- function(x) {
  s.x <- summary(x)
  iqr<-s.x[5]-s.x[2]
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2], q2=s.x[3], 
       q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr ) }

countNA <- function(x) {
  mis_x <- NULL
  for (j in 1:ncol(x)) {mis_x[j] <- sum(is.na(x[,j])) }
  mis_x <- as.data.frame(mis_x)
  rownames(mis_x) <- names(x)
  mis_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {mis_i <- mis_i + as.numeric(is.na(x[,j])) }
  list(mis_col=mis_x,mis_ind=mis_i) }

countX <- function(x,X) {
  n_x <- NULL
  for (j in 1:ncol(x)) {n_x[j] <- sum(x[,j]==X) }
  n_x <- as.data.frame(n_x)
  rownames(n_x) <- names(x)
  nx_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {nx_i <- nx_i + as.numeric(x[,j]==X) }
  list(nx_col=n_x,nx_ind=nx_i) }
```

## Sample load

```{r, results='hide'}
# Clear plots
if(!is.null(dev.list())) dev.off()

# Clean workspace
rm(list=ls())

# Users file path
miquel_fp <- "C:/Users/Miquel/Documents/GitHub/ADEI/"
xavi_fp <- "~/Documents/FIB/ADEI/ADEI/"
filepath <- xavi_fp

# Set working directory
setwd(filepath)

# Load data from file
load(paste0(filepath,"MyOldCars-Raw.RData"))

# Index reset
row.names(df) <- NULL
```

# Data Description

During this project we will be working with a subset of the pre-treated original dataset ["Uk used car dataset"](https://www.kaggle.com/adityadesai13/used-car-dataset-ford-and-mercedes). A sample of 5000 cars has been randomly selected from Mercedes, BMW, Volkwagen and Audi manufacturers and stored into a RData file ***MyOldCars-Raw.RData***.

## Original variables description

-   **model:** Car model.
-   **year:** Car registration year.
-   **price:** Car price in £.
-   **transmission:** Type of transmission ["Manual", "Automatic", "Semi-Auto"].
-   **mileage:** Distance used, accumulated miles.
-   **fuelType:** Type of engine fuel ["Petrol", "Diesel", "Hybrid", "Other" ].
-   **tax:** Applied road tax.
-   **mpg:** Miles per gallon.
-   **engineSize:** Engine size in liters. The cars with engine size 0 are in fact electric cars, nevertheless Mercedes C class, and other given cars are not electric cars,so data imputation is required.
-   **manufacturer:** Car manufacturer ["Audi", "BMW", "Mercedes", "VW"].

```{r}
summary(df)
head(df, 3)
```

# Univariate Descriptive Analysis

In this step of the process original numeric variables corresponding to qualitative concepts have to be converted to factors. New factors grouping original levels will be considered very positively.

Additionally original numeric variables corresponding to real quantitative concepts are kept as numeric but additional factors should also be created as a discretization of each numeric variable.

For each variable we will perform the necessary transformations and also visualize its distribution.

## Numeric variables

### years_sell

From **year** we can create a new variable called **years_sell**. It will contain the same information as **year** but it will give more valuable information for a human understanding perspective.

**years_sell** represent the number of years the car has been used.

```{r}
# No se si aquest ajust es gaire correcte. No hi han dades amb any de fabricació més enllà del 2020. Per tant deixar aquest gap de dos anys en la nova variable on no hi haurà cap valor aleshores no se si es bona idea fer-ho des del 2022 o 2020-2021
df$years_sell <-  2022 - df$year
summary(df$years_sell)
table(df$years_sell,useNA="always")
barplot(table(df$years_sell,useNA="always"), main = "years_sell Barplot", col = "blue")
```

### price

```{r}
summary(df$price)
Boxplot(df$price)
```

### mileage

```{r}
summary(df$mileage)
Boxplot(df$mileage)
```

### mpg

```{r}
summary(df$mpg)
Boxplot(df$mpg)
```

### tax

```{r}
summary(df$tax)
Boxplot(df$tax)
```


## Factors


### model

```{r}
# TODO: Fer una bona visualitzacio. barplot dona poca informacio i el summary 
# queda massa llarg. un treemap de models de cotxe podria estar bé i un summary
# custom on es vegin intervals o agrupacions segons valors també. 

df$model<-factor(paste0(trimws(df$manufacturer),"-",trimws(df$model)))

summary(df$model)
barplot(summary(df$model), main = "Model Barplot", col = "blue", horiz=TRUE)
```

### year

As you could imagine the distribution of years and years_sell is the same, but moved from right to left as a result of the subtract operation.

```{r}
df[which(df$year<=2009),"year"] <- "2009 or before"

df$year <- factor(df$year)
df$year <- factor(df$year, labels = paste0("f.Year-",levels(df$year)))

summary(df$year)
barplot(summary(df$year), main = "year", col = "blue")
```

### transmission

```{r}
df$transmission<-factor(df$transmission)
df$transmission <- factor(df$transmission, levels = c("Manual","Semi-Auto","Automatic"),labels = paste0("f.Trans-",c("Manual","SemiAuto","Automatic")))

summary(df$transmission)
barplot(summary(df$transmission), main = "Transmission Barplot", col = "blue")
```

### fuelType

```{r}
df$fuelType<-factor(df$fuelType)
df$fuelType <- factor(df$fuelType, labels = paste0("f.Fuel-",levels(df$fuelType)))

summary(df$fuelType)
barplot(summary(df$fuelType), main = "FuelType Barplot", col = "blue")
```

### engineSize

```{r}
df$engineSize<-factor(df$engineSize)
df$engineSize <- factor(df$engineSize, labels = paste0("f.EngSize-",levels(df$engineSize)))

summary(df$engineSize)
barplot(summary(df$engineSize), main = "EngineSize Barplot", col = "blue")
```

### manufacturer variable

```{r}
df$manufacturer<-factor(df$manufacturer)
df$manufacturer <- factor(df$manufacturer, labels = paste0("f.Mfr-",levels(df$manufacturer)))

summary(df$manufacturer)
barplot(summary(df$manufacturer), main = "Manufacturer Barplot", col = "blue")
```


# Data Quality Report

## Initialization of counts for missings, outliers and errors. 

```{r}

#######################################################
imis<-rep(0,nrow(df))  # rows - cars
jmis<-rep(0,ncol(df))  # columns - variables
######################################################
mis1<-countNA(df) #There are no missings at the beginning 
mis1$mis_ind # Number of missings for the current set of cars
mis1$mis_col # Number of missings for the current set of variables

sum(mis1$mis_ind)
sum(mis1$mis_col)

#######################################################
iouts<-rep(0,nrow(df))  # rows - cars
jouts<-rep(0,ncol(df))  # columns - variables
######################################################

#######################################################
ierrs<-rep(0,nrow(df))  # rows - cars
jerrs<-rep(0,ncol(df))  # columns - variables
######################################################
```

## Errors

After the first analysis of the samples and the provided documentation of the dataset
we could say that the only visible errors are in the engineSize variable. 

Engine size equal to zero is considered as an electrical vehicle so this error
in the data needs to be considered and treated properly. 

```{r}
sel<-which(df$engineSize==0)
ierrs[sel]<-ierrs[sel]+1 
df[sel,"engineSize"]<-NA
selmiss <- sel
jerrs[9] <- length(sel)
```

## Univariate Outliers

### price

```{r}
Boxplot(df$price)
var_out<-calcQ(df$price)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_price<-which((df$price<var_out$souti)|(df$price>var_out$souts))#souts abline
iouts[llout_price]<-iouts[llout_price]+1
jouts[3]<-length(llout_price)
```

### mileage

```{r}
Boxplot(df$mileage)
var_out<-calcQ(df$mileage)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_mileage<-which((df$mileage<var_out$souti)|(df$mileage>var_out$souts))#souts abline
iouts[llout_mileage]<-iouts[llout_mileage]+1
jouts[5]<-length(llout_mileage)
# Assignation of an NA to my response variable:
df[llout_mileage,"mileage"]<-NA #llout
```

### tax

```{r}
Boxplot(df$tax)
var_out<-calcQ(df$tax)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_tax<-which((df$tax<var_out$souti)|(df$tax>var_out$souts))#souts abline
iouts[llout_tax]<-iouts[llout_tax]+1
jouts[7]<-length(llout_tax)
# Assignation of an NA to my response variable:
df[llout_tax,"tax"]<-NA #llout
```

### mpg

```{r}
Boxplot(df$mpg)
var_out<-calcQ(df$mpg)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_mpg<-which((df$mpg<var_out$souti)|(df$mpg>var_out$souts))#souts abline
iouts[llout_mpg]<-iouts[llout_mpg]+1
jouts[8]<-length(llout_mpg)
# Assignation of an NA to my response variable:
df[llout_mpg,"mpg"]<-NA #llout
```

### years_sell

```{r}
Boxplot(df$years_sell)
var_out<-calcQ(df$years_sell)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

# Outliers:
llout_years_sell<-which((df$years_sell<var_out$souti)|(df$years_sell>var_out$souts))#souts abline
iouts[llout_years_sell]<-iouts[llout_years_sell]+1
jouts[11]<-length(llout_years_sell)
# Assignation of an NA to my response variable:
df[llout_years_sell,"years_sell"]<-NA #llout
```

### Number of missing values of each variable

```{r}
missings_ranking_sortlist <- sort.list(mis1$mis_col, decreasing = TRUE)
for(j in missings_ranking_sortlist) {
  print(paste(names(df)[j]," : ", mis1$mis_col$mis_x[j]))
}
```

#### Number of errors per each variable

```{r}
errors_ranking_sortlist <- sort.list(jerrs, decreasing = TRUE)
for(j in errors_ranking_sortlist) {
  if(!is.na(names(df)[j])) { print(paste(names(df)[j], " : ", jerrs[j])) }
}
```

#### Number of outilers per each variable

```{r}
outliers_ranking_sortlist <- sort.list(jouts, decreasing = TRUE)
for(j in outliers_ranking_sortlist) {
  if(!is.na(names(df)[j])) print(paste(names(df)[j], " : ", jouts[j]))
}
```

#### Number of missing values individual

```{r}
barplot(table(imis),main = "Missings per individual Barplot", col = "blue")
```

#### Number of errors individual

```{r}
barplot(table(ierrs), main = "Errors per individual Barplot", col = "blue")
```

#### Number of outliers individual

```{r}
barplot(table(iouts), main = "Outliers per individual Barplot", col = "blue")
```

#### Multivariant Outlier detection

```{r}
library(mvoutlier)
vars_con<-names(df)[c(3,5,7,8, 11)]
ll<-which(is.na(df$price))
if (length( ll ) > 0 ) df<-df[-ll,]
summary(df[,vars_con])
# aq.plot(df[,c(vars_con)]) # Might not work
names(df)
vars_con
names(df)
mout<-aq.plot(df[,vars_con],delta=qchisq(0.995,5),quan=0.995)

library(chemometrics)
summary(df[,vars_con])
mout<-Moutlier(df[,c(3,5,8)],quantile = 0.995, plot = TRUE)#FALTA LA 11 years_sell

ll<-which(mout$rd>mout$cutoff)
Boxplot(mout$rd)
df[ll,c(vars_res,vars_con)]
df$mout <- 0
df$mout[ ll ]<-1
df$mout <- factor( df$mout, labels=c( "NoMOut","YesMOut"))
table(df$mout)
```

#### Create variable adding the total number missing values, outliers and errors

```{r}
total_missings <- 0
total_errors <- 0
total_outliers <- 0

for(m in imis) { total_missings <- total_missings + m}
for(e in ierrs) {total_errors <- total_errors + e  }
for(o in iouts) {total_outliers <- total_outliers + o }
```

#### FALTAAAAAAAAAAAAAAAAAAAAAAAAAAAAA CORRELATION I AIXOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO

```{r}
#CONSIDERAR AQUESTES AGRUPACIONS TMBBBBBBBBBBBBBBBBBBBB "VALORS RESIDUALS"
table(df$year)
df[which(df$year<=2009),"year"] <- "2009 or before"
df$year<-factor(df$year)
levels(df$year)
barplot(table(df$year))

table(df$engineSize)
df[which(df$engineSize>=4.0),"engineSize"] <- "4.0 or more" #or with 3.2 or 4.2

table(df$years_sell)
df[which(df$years_sell>=13),"years_sell"] <- "13 or more"
```

### Imputation numeric variables

```{r}
library(missMDA)
names(df)
vars_con<-names(df)[c(5,7,8, 11)] #Variable target NOOOOOOOOOOOOOOOOOOOOO
vars_res<-names(df)[c(3)]

summary(df[,vars_con])
res.impca<-imputePCA(df[,vars_con],ncp=4)

summary(res.impca$completeObs)
```

#### mileage variable

```{r}
par(nfrow = c(1,2))
hist(df$mileage)
hist(res.impca$completeObs[,"mileage"])
quantile(df$mileage,seq(0,1,0.1),na.rm=T)
round(quantile(res.input$completeObs[,"mileage"],seq(0,1,0.1),na.rm=T),dig=1)
```

#### tax variable

```{r}
par(nfrow=c(1,2))
hist(df$tax)
hist(res.impca$completeObs[,"tax"])
quantile(df$tax,seq(0,1,0.1),na.rm=T)
round(quantile(res.input$completeObs[,"tax"],seq(0,1,0.1),na.rm=T),dig=1)
```

#### mpg variable

```{r}
par(nfrow = c(1,2))
hist(df$mpg)
hist(res.impca$completeObs[,"mpg"])
quantile(df$mpg,seq(0,1,0.1),na.rm=T)
round(quantile(res.input$completeObs[,"mpg"],seq(0,1,0.1),na.rm=T),dig=1)
```

#### years_sell variable

```{r}
par(nfrow = c(1,2))
hist(df$years_sell)
hist(res.impca$completeObs[,"years_sell"])
quantile(df$years_sell,seq(0,1,0.1),na.rm=T)
round(quantile(res.input$completeObs[,"years_sell"],seq(0,1,0.1),na.rm=T),dig=1)
```

```{r}
df[ , vars_con ]<-res.impca$completeObs
```

### Imputation factors

```{r}
vars_dis<-names(df)[c(1:2, 4, 6, 9, 10)]
vars_res<-names(df)[c(3)]
summary(df[,vars_dis])
res.immca<-imputeMCA(df[,vars_dis],ncp=10)
summary(res.immca$completeObs)
df [c(1:2, 4, 6, 9, 10)] <- res.immca$completeObs
```

#### model variable

```{r}
par(mfrow=c(1,2))
barplot(table(df$model),col="red")
barplot(table(res.input$completeObs[,"model"]),col="blue")
```

#### year variable

```{r}
par(mfrow=c(1,2))
barplot(table(df$year),col="red")
barplot(table(res.input$completeObs[,"year"]),col="blue")
```

#### transmission variable

```{r}
par(mfrow=c(1,2))
barplot(table(df$transmission),col="red")
barplot(table(res.input$completeObs[,"transmission"]),col="blue")
```

#### fuelType variable

```{r}
par(mfrow=c(1,2))
barplot(table(df$fuelType),col="red")
barplot(table(res.input$completeObs[,"fuelType"]),col="blue")
```

#### engineSize variable

```{r}
par(mfrow=c(1,2))
barplot(table(df$engineSize),col="red")
barplot(table(res.input$completeObs[,"engineSize"]),col="blue")
```

#### manufacturer variable

```{r}
par(mfrow=c(1,2))
barplot(table(df$manufacturer),col="red")
barplot(table(res.input$completeObs[,"manufacturer"]),col="blue")
```

```{r}
df[ , vars_dis ]<-res.immca$completeObs 
sum(countNA(df)$mis_ind)==0
```

### Profiling

```{r}
library(FactoMineR)
summary(df$price)
# The "variable to describe cannot have NA ###################################
res.condes<-condes(df,3)

res.condes$quanti  # Global association to numeric variables
res.condes$quali # Global association to factors
res.condes$category  # Partial association to significative levels in factors



 

library(FactoMineR)
summary(df$y.bin)
# The "variable to describe cannot have NA ###################################
res.catdes<-catdes(df,13)

res.catdes$quanti.var  # Global association to numeric variables
res.catdes$quanti # Partial association of numeric variables to levels of outcome factor
res.catdes$test.chi2 # Global association to factors
res.catdes$category  # Partial association to significative levels in factors



```

### Definition of binary outcome: Audi

Create binary target, define lists of numeric and qualitative variables and save your raw base database

```{r}

# Binary Target: Audi?

df$Audi<-ifelse(df$manufacturer == "Audi",1,0)##1 es compleix
df$Audi<-factor(df$Audi,labels=paste("Audi",c("No","Yes")))#treure Audi verd
summary(df$Audi)
# Pie
piepercent<-round(100*(table(df$Audi)/nrow(df)),dig=2); piepercent
pie(table(df$Audi),col=heat.colors(2),labels=paste(piepercent,"%"))
legend("topright", levels(df$Audi), cex = 0.8, fill = heat.colors(2))
# Bar Chart
barplot(table(df$Audi),main="Barplot Binary Outcome - Factor",col=c("red","green"))

```
